<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Sensores - Clima Consciente</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary: #117A65;
            --primary-dark: #0B5345;
            --primary-light: #48C9B0;
            --white: #FFFFFF;
            --dark: #1A1A1A;
            --dark-gray: #333333;
            --medium-gray: #666666;
            --light-gray: #E5E5E5;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .logo i {
            color: var(--primary);
            margin-right: 10px;
            font-size: 2.2rem;
        }
        
        .logo-highlight {
            color: var(--primary);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .subtitle {
            color: var(--medium-gray);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .status-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .status.connected {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }
        
        .status.disconnected {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected .status-dot {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .disconnected .status-dot {
            background-color: var(--danger);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sensor-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .sensor-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .sensor-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .temp-icon {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }
        
        .humidity-icon {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        .pressure-icon {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .heat-icon {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .sensor-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .sensor-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }
        
        .sensor-unit {
            font-size: 1.2rem;
            color: var(--medium-gray);
            margin-left: 5px;
        }
        
        .sensor-data {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }
        
        .data-item {
            text-align: center;
        }
        
        .data-label {
            font-size: 0.9rem;
            color: var(--medium-gray);
            margin-bottom: 5px;
        }
        
        .data-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .chart-container {
            height: 100px;
            margin-top: 20px;
        }
        
        .last-update {
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .debug-panel {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
        }
        
        .debug-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .debug-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .debug-content {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .debug-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .timestamp {
            color: var(--medium-gray);
            margin-right: 10px;
        }
        
        .value {
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(17, 122, 101, 0.3);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 122, 101, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-3px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .sensor-value {
                font-size: 2.2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="#" class="logo">
                <i class="fas fa-leaf"></i>
                <span>Clima<span class="logo-highlight">Consciente</span></span>
            </a>
            <h1>Monitoramento de Sensores</h1>
            <p class="subtitle">Dados em tempo real dos sensores ambientais</p>
            
            <div class="status-container">
                <div id="status" class="status connected">
                    <div class="status-dot"></div>
                    <span id="status-text">Conectando ao Firebase...</span>
                </div>
            </div>
        </header>

        <div class="dashboard">
            <div class="sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon temp-icon">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <h2 class="sensor-title">Temperatura</h2>
                </div>
                <div class="sensor-value" id="temperature">--<span class="sensor-unit">°C</span></div>
                
                <div class="sensor-data">
                    <div class="data-item">
                        <div class="data-label">Mínima</div>
                        <div class="data-value" id="temp-min">--°C</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Máxima</div>
                        <div class="data-value" id="temp-max">--°C</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-temp"></canvas>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon humidity-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <h2 class="sensor-title">Umidade</h2>
                </div>
                <div class="sensor-value" id="humidity">--<span class="sensor-unit">%</span></div>
                
                <div class="sensor-data">
                    <div class="data-item">
                        <div class="data-label">Mínima</div>
                        <div class="data-value" id="humidity-min">--%</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Máxima</div>
                        <div class="data-value" id="humidity-max">--%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-humidity"></canvas>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon pressure-icon">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </div>
                    <h2 class="sensor-title">Pressão</h2>
                </div>
                <div class="sensor-value" id="pressure">--<span class="sensor-unit">hPa</span></div>
                
                <div class="sensor-data">
                    <div class="data-item">
                        <div class="data-label">Tendência</div>
                        <div class="data-value" id="pressure-trend">--</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-pressure"></canvas>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon heat-icon">
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <h2 class="sensor-title">Sensação Térmica</h2>
                </div>
                <div class="sensor-value" id="heat-index">--<span class="sensor-unit">°C</span></div>
                
                <div class="sensor-data">
                    <div class="data-item">
                        <div class="data-label">Diferença</div>
                        <div class="data-value" id="heat-diff">--°C</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-heat"></canvas>
                </div>
            </div>
        </div>
        
        <div class="last-update">
            <i class="fas fa-clock"></i> Última atualização: <span id="last-update">--</span>
        </div>
        
        <div class="action-buttons">
            <button id="refresh-btn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Atualizar Dados
            </button>
            <a href="/" class="btn btn-outline">
                <i class="fas fa-home"></i> Voltar para o Site
            </a>
        </div>
        
        <div class="debug-panel">
            <h3 class="debug-title"><i class="fas fa-bug"></i> Informações de Debug</h3>
            <div class="debug-content" id="debug-console">
                <div class="debug-item">Inicializando monitoramento de sensores...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase - Versão Corrigida
        const firebaseConfig = {
            apiKey: "AIzaSyADqE8cOi1kUMQgWkFMg5i6jSZtpUnRLOE",
            authDomain: "clima-consciente.firebaseapp.com",
            databaseURL: "https://clima-consciente-default-rtdb.firebaseio.com",
            projectId: "clima-consciente",
            storageBucket: "clima-consciente.firebasestorage.app",
            messagingSenderId: "1022185043717",
            appId: "1:1022185043717:web:06577ec98b38bd9f70a96c"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Elementos da UI
        const temperatureElement = document.getElementById('temperature');
        const humidityElement = document.getElementById('humidity');
        const pressureElement = document.getElementById('pressure');
        const heatIndexElement = document.getElementById('heat-index');
        const lastUpdateElement = document.getElementById('last-update');
        const statusElement = document.getElementById('status');
        const statusTextElement = document.getElementById('status-text');
        const debugConsole = document.getElementById('debug-console');
        const refreshButton = document.getElementById('refresh-btn');

        // Variáveis para armazenar histórico
        let temperatureHistory = [];
        let humidityHistory = [];
        let pressureHistory = [];
        let heatIndexHistory = [];
        let timeLabels = [];
        let lastData = null;

        // Criar gráficos
        const tempChart = new Chart(document.getElementById('chart-temp'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: temperatureHistory,
                    borderColor: '#F44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        display: false
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        const humidityChart = new Chart(document.getElementById('chart-humidity'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Umidade (%)',
                    data: humidityHistory,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        display: false
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        const pressureChart = new Chart(document.getElementById('chart-pressure'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Pressão (hPa)',
                    data: pressureHistory,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        display: false
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        const heatChart = new Chart(document.getElementById('chart-heat'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Sensação Térmica (°C)',
                    data: heatIndexHistory,
                    borderColor: '#FFC107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        display: false
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        // Função para adicionar mensagem de debug
        function addDebugMessage(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('pt-BR');
            const debugItem = document.createElement('div');
            debugItem.className = 'debug-item';
            debugItem.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            debugConsole.prepend(debugItem);
            
            // Manter apenas as 10 últimas mensagens
            if (debugConsole.children.length > 10) {
                debugConsole.removeChild(debugConsole.lastChild);
            }
        }

        // Função para atualizar a UI com os dados
        function updateSensorUI(data) {
            const now = new Date();
            lastUpdateElement.textContent = now.toLocaleString('pt-BR');
            
            // Atualizar histórico e labels
            timeLabels.push(now.toLocaleTimeString('pt-BR'));
            if (timeLabels.length > 15) timeLabels.shift();
            
            // Temperatura
            if (data.temperatura !== undefined) {
                temperatureElement.innerHTML = `${data.temperatura.toFixed(1)}<span class="sensor-unit">°C</span>`;
                temperatureHistory.push(data.temperatura);
                if (temperatureHistory.length > 15) temperatureHistory.shift();
                
                document.getElementById('temp-min').textContent = 
                    temperatureHistory.length > 0 ? `${Math.min(...temperatureHistory).toFixed(1)}°C` : '--°C';
                document.getElementById('temp-max').textContent = 
                    temperatureHistory.length > 0 ? `${Math.max(...temperatureHistory).toFixed(1)}°C` : '--°C';
                
                tempChart.data.labels = timeLabels;
                tempChart.data.datasets[0].data = temperatureHistory;
                tempChart.update();
            }
            
            // Umidade
            if (data.umidade !== undefined) {
                humidityElement.innerHTML = `${data.umidade.toFixed(0)}<span class="sensor-unit">%</span>`;
                humidityHistory.push(data.umidade);
                if (humidityHistory.length > 15) humidityHistory.shift();
                
                document.getElementById('humidity-min').textContent = 
                    humidityHistory.length > 0 ? `${Math.min(...humidityHistory).toFixed(0)}%` : '--%';
                document.getElementById('humidity-max').textContent = 
                    humidityHistory.length > 0 ? `${Math.max(...humidityHistory).toFixed(0)}%` : '--%';
                
                humidityChart.data.labels = timeLabels;
                humidityChart.data.datasets[0].data = humidityHistory;
                humidityChart.update();
            }
            
            // Pressão
            if (data.pressao !== undefined) {
                pressureElement.innerHTML = `${data.pressao.toFixed(0)}<span class="sensor-unit">hPa</span>`;
                pressureHistory.push(data.pressao);
                if (pressureHistory.length > 15) pressureHistory.shift();
                
                // Calcular tendência
                if (pressureHistory.length > 1) {
                    const current = pressureHistory[pressureHistory.length - 1];
                    const previous = pressureHistory[pressureHistory.length - 2];
                    const trend = current > previous ? "Subindo" : current < previous ? "Caindo" : "Estável";
                    document.getElementById('pressure-trend').textContent = trend;
                } else {
                    document.getElementById('pressure-trend').textContent = "--";
                }
                
                pressureChart.data.labels = timeLabels;
                pressureChart.data.datasets[0].data = pressureHistory;
                pressureChart.update();
            }
            
            // Sensação térmica
            if (data.sensacao_termica !== undefined) {
                heatIndexElement.innerHTML = `${data.sensacao_termica.toFixed(1)}<span class="sensor-unit">°C</span>`;
                heatIndexHistory.push(data.sensacao_termica);
                if (heatIndexHistory.length > 15) heatIndexHistory.shift();
                
                // Calcular diferença com a temperatura atual
                if (data.temperatura !== undefined) {
                    const diff = data.sensacao_termica - data.temperatura;
                    document.getElementById('heat-diff').textContent = `${diff.toFixed(1)}°C`;
                } else {
                    document.getElementById('heat-diff').textContent = "--°C";
                }
                
                heatChart.data.labels = timeLabels;
                heatChart.data.datasets[0].data = heatIndexHistory;
                heatChart.update();
            }
            
            lastData = data;
        }

        // Referência para os dados no Firebase
        const sensorRef = database.ref('clima');
        
        // Ouvir mudanças nos dados do Firebase
        sensorRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                addDebugMessage("Dados recebidos do Firebase: " + JSON.stringify(data));
                updateSensorUI(data);
                statusElement.classList.remove('disconnected');
                statusElement.classList.add('connected');
                statusTextElement.textContent = "Conectado ao Firebase - Dados Recebidos";
            } else {
                addDebugMessage("Nenhum dado encontrado no caminho 'clima'.");
                statusElement.classList.remove('connected');
                statusElement.classList.add('disconnected');
                statusTextElement.textContent = "Sem dados no Firebase";
            }
        }, (error) => {
            addDebugMessage("Erro ao acessar Firebase: " + error.message);
            statusElement.classList.remove('connected');
            statusElement.classList.add('disconnected');
            statusTextElement.textContent = "Erro de conexão: " + error.code;
        });

        // Botão para atualizar manualmente
        refreshButton.addEventListener('click', () => {
            addDebugMessage("Atualização manual solicitada.");
            sensorRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateSensorUI(data);
                    addDebugMessage("Dados atualizados manualmente.");
                } else {
                    addDebugMessage("Nenhum dado disponível para atualização.");
                }
            }).catch((error) => {
                addDebugMessage("Erro na atualização: " + error.message);
            });
        });

        // Verificar periodicamente se há dados
        setInterval(() => {
            if (!lastData) {
                sensorRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateSensorUI(data);
                        addDebugMessage("Dados recuperados pela verificação periódica.");
                    }
                });
            }
        }, 30000); // Verificar a cada 30 segundos

        // Inicialização
        addDebugMessage("Página de monitoramento inicializada.");
        addDebugMessage("Conectando ao Firebase: " + firebaseConfig.databaseURL);
        addDebugMessage("Projeto: " + firebaseConfig.projectId);
    </script>
</body>
</html>